const express = require("express");
const { matchedData } = require("express-validator");
const router = express.Router();
const mysql = require("mysql");
const conection = require("../connection");
const { Tournament, TournamentPlayers, Team, TeamMember } = require("../models/models");
const { Op } = require("sequelize");

require("dotenv").config();
db = conection;

async function f_getPlayersInTournament(tournamentId) {
    const playersInTournament = await TournamentPlayers.findAll({
        where: {
            id: tournamentId,
        },
    });

    return playersInTournament
}

async function f_getTeamsInTournament(tourPlayerIds) {
    const teamsIDInTournament = await TeamMember.findAll({
        where: {
            id: tourPlayerIds,
        },
    });

    const teamIds = [];
    for (let i = 0; i < teamsIDInTournament.length; i++)
        teamIds.push(teamsIDInTournament[i].teamId);

    const teamsInTournament = await Team.findAll({
        where: {
            id: teamIds,
        },
    })

    return teamsInTournament
}

async function generateMatches(tournamentId, team_members) {
    let teamCount = team_members.length

    const partidos = [];
    for (let i = 0; i < teamCount; i++) {
        const fila = [];
        for (let j = 0; j < teamCount; j++) {
            if (i === j)
                fila.push(null); // No hay enfrentamiento consigo mismo
            else if (partidos[j] && partidos[j][i])
                fila.push(partidos[j][i]); // Evita enfrentamientos duplicados
            else {
                const rnd = Math.floor(Math.random() * 3); // Genera un número aleatorio entre 0 y 2
                let enfrentamiento;
                if (rnd === 0)
                    enfrentamiento = { local: i, visitante: j }; // Equipo i juega en casa contra equipo j
                else if (rnd === 1)
                    enfrentamiento = { local: j, visitante: i }; // Equipo j juega en casa contra equipo i
                else
                    enfrentamiento = null; // No hay enfrentamiento
                
                fila.push(enfrentamiento);
            }
        }
        partidos.push(fila);
    }

    return partidos;
}

async function fixTeams() {

}

const getTeamsInTournament = async (req, res) => {
    const playersInTournament = f_getPlayersInTournament(tournamentId)

    const tourPlayerIds = [];
    for (let i = 0; i < playersInTournament.length; i++)
        tourPlayerIds.push(playersInTournament[i].userId);

    res.send(f_getTeamsInTournament(tourPlayerIds))
};

const getPlayersInTournament = async (req, res) => {
    res.send(f_getPlayersInTournament(req.body.tournamentId))
};

const generateTournament = async (req, res) => {
    const { tournamentId } = req.body;
    const tournamentInfo = await Tournament.findOne({ where: { id: tournamentId } })

    // Recopilar todos los equipos y jugadores disponibles en el torneo
    const playersInTournament = f_getPlayersInTournament(tournamentId)

    const tourPlayerIds = [];
    for (let i = 0; i < playersInTournament.length; i++)
        tourPlayerIds.push(playersInTournament[i].userId);

    const teamsInTournament = f_getTeamsInTournament(tourPlayerIds)
    let teamsNumber = teamsInTournament.length
    // si es modo equipos
    // asignación de partidos
    if (tournamentInfo.type == 1) {
        generateMatches(tournamentId, teamsInTournament)
    }
    // si es modo equipos y jugadores
    // ver jugadores sin equipo y asignarles a un equipo
    else if (tournamentInfo.type == 2) {
        fixTeams() // mete a jugadores sin equipo en equipos sin mucha gente o crea nuevos equipos si necesario
        generateMatches(tournamentId, teamsInTournament)   
    }
}

const createTournament = async (req, res) => {
    try {
        // Extract data from request body
        const { name, description, sport, date_start, date_end, min_teams, max_teams, max_players_team, rounds, type, privacity } = req.body;

        // Create tournament in database
        const [tournament, created] = await Tournament.findOrCreate({
            where: {
                name,
            },
            defaults: {
                name, description, sport, date_start, date_end, min_teams, max_teams, max_players_team, rounds, type, privacity
            },
        });

        if (!created)
            return res.status(409).json({ message: "Tournament already exists" });

        // Send response with success message
        res.status(201).json({ message: "Tournament created successfully" });
    } catch (err) {
        console.error(err);
        res.status(500).json({ message: "Internal server error" });
    }
};

const getTournaments = async (req, res) => {
    try {
        var data = "";
        data = await Tournament.findAll();
        res.send(data);
    } catch (err) {
        console.log(err); //Opcional
        handleHttpError(res, "ERROR_GET_TOURNAMENT"); //Si nos sirve el de por defecto que hemos establecido, no es necesario pasar el 403
    }
};

const suscribeTournament = async (req, res) => {
    
};

const getMyTournaments = async (req, res) => {
    try {
        var data = "";
        data = await TournamentPlayers.findAll({
            where: {
                UserId: req.user.id,
            },
        });

        const tournamentIds = [];
        for (let i = 0; i < data.length; i++)
            tournamentIds.push(data[i].tournamentIds);
        
        const relatedRecords = await Tournament.findAll({
            where: {
                id: tournamentIds,
            },
        });

        res.send(relatedRecords);
    } catch (err) {
        console.log(err);

        handleHttpError(res, "ERROR_GET_MY_TOURNAMENT");
    }
};


module.exports = { createTournament, getTournaments, suscribeTournament, getMyTournaments, generateTournament, getPlayersInTournament, getTeamsInTournament };
